<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exercise Monitoring</title>
  <link rel="stylesheet" href="/static/style.css">

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
</head>
<body>
  <div class="container">
    <header class="exercise-header">
      <h1 id="exercise-name">Exercise</h1>
      <button id="stop-btn">Stop Exercise</button>
    </header>
    
    <main class="exercise-container">
      <div class="stats-panel">
        <div class="stat-box">
          <h3>REPS</h3>
          <div id="rep-counter" class="counter">0</div>
        </div>
        
        <div class="stat-box">
          <h3>FORM</h3>
          <div id="form-status" class="status">OK</div>
        </div>
      </div>
      
      <div class="video-feed">
        <div class="video-placeholder" style="position: relative; display:inline-block;">
          <video id="camera-stream" autoplay playsinline width="640" height="480" style="border:2px solid #444; border-radius:8px;"></video>
          <canvas id="pose-canvas" width="640" height="480" style="position: absolute; top: 0; left: 0; border-radius:8px;"></canvas>
        </div>
      </div>
      
      <div class="feedback-panel">
        <h3>FEEDBACK</h3>
        <div id="feedback-text" class="feedback-text">No feedback yet</div>
      </div>
    </main>
  </div>

  <script>
    // const API_BASE_URL = 'https://yalla-ai.onlinetestingserver.com';
    const API_BASE_URL = 'http://localhost:8000';
    let ws = null;
    let pose = null;
    let camera = null;
    const sessionId = localStorage.getItem("sessionId");
    const exerciseName = localStorage.getItem("exerciseName");

    let personDetected = true;
    let missingFrames = 0;
    const MISSING_THRESHOLD = 0;
    
    // Camera jerk detection variables
    let lastKeypoints = null;
    let lastFrameTimestamp = null;
    let cameraJerkThreshold = 0.2;
    let isCameraJerk = false;
    let jerkRecoveryFrames = 0;
    const JERK_RECOVERY_COUNT = 30;
    
    // Rep cooldown to prevent multiple counts
    let lastRepTime = 0;
    const repCooldownMs = 500; // 1 second cooldown after a rep

    document.addEventListener("DOMContentLoaded", () => {
      if (!sessionId) {
        alert("No active session. Redirecting...");
        window.location.href = "index.html";
        return;
      }
      
      document.getElementById("exercise-name").textContent = exerciseName;
      
      initializeMediaPipe();
      initializeWebSocket();
      setupEventListeners();
    });

    function initializeMediaPipe() {
      const videoElement = document.getElementById('camera-stream');
      const canvasElement = document.getElementById('pose-canvas');
      const canvasCtx = canvasElement.getContext('2d');

      pose = new Pose({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
      });

      pose.setOptions({
        modelComplexity: 0,
        smoothLandmarks: true,
        enableSegmentation: false,
        smoothSegmentation: false,
        minDetectionConfidence: 0.9,
        minTrackingConfidence: 0.9
      });

      pose.onResults(onPoseResults);

      camera = new Camera(videoElement, {
        onFrame: async () => await pose.send({image: videoElement}),
        width: 640,
        height: 480
      });

      camera.start();
    }

    function detectCameraJerk(currentKeypoints, previousKeypoints) {
      if (!previousKeypoints) return false;
      
      // Calculate movement for each keypoint
      const movements = [];
      let totalMovement = 0;
      let validPoints = 0;
      
      for (let i = 0; i < currentKeypoints.length; i++) {
        if (currentKeypoints[i][3] > 0.5 && previousKeypoints[i][3] > 0.5) {
          const dx = currentKeypoints[i][0] - previousKeypoints[i][0];
          const dy = currentKeypoints[i][1] - previousKeypoints[i][1];
          const distance = Math.sqrt(dx*dx + dy*dy);
          movements.push(distance);
          totalMovement += distance;
          validPoints++;
        }
      }
      
      if (validPoints === 0) return false;
      
      // Calculate average movement and standard deviation
      const avgMovement = totalMovement / validPoints;
      
      // Calculate standard deviation
      let variance = 0;
      for (const movement of movements) {
        variance += Math.pow(movement - avgMovement, 2);
      }
      const stdDev = Math.sqrt(variance / movements.length);
      
      // Camera jerk detection:
      // 1. High average movement across all points
      // 2. Low standard deviation (all points moving similarly)
      // This indicates the whole frame moved, suggesting camera jerk
      return avgMovement > cameraJerkThreshold && stdDev < avgMovement * 0.4;
    }

    function onPoseResults(results) {
      const canvasElement = document.getElementById('pose-canvas');
      const canvasCtx = canvasElement.getContext('2d');
      const currentTimestamp = Date.now();

      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

      canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

      if (results.poseLandmarks) {
        missingFrames = 0;

        if (!personDetected) {
          personDetected = true;
          document.getElementById("form-status").textContent = "OK";
          document.getElementById("form-status").className = "status good";
          document.getElementById("feedback-text").textContent = "Person detected";
        }

        drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, { color: '#00FF00', lineWidth: 2 });
        drawLandmarks(canvasCtx, results.poseLandmarks, { color: '#FF0000', lineWidth: 1, radius: 3 });

        const keypoints = results.poseLandmarks.map(landmark => [
          landmark.x,
          landmark.y,
          landmark.z || 0,
          landmark.visibility || 1.0
        ]);

        // Check for camera jerk
        const detectedJerk = detectCameraJerk(keypoints, lastKeypoints);
        
        if (detectedJerk && !isCameraJerk) {
          isCameraJerk = true;
          jerkRecoveryFrames = JERK_RECOVERY_COUNT;
          console.log("Camera jerk detected - ignoring frames");
        }
        
        // Handle jerk recovery
        if (isCameraJerk) {
          jerkRecoveryFrames--;
          if (jerkRecoveryFrames <= 0) {
            isCameraJerk = false;
            console.log("Camera jerk recovery complete");
          }
        }
        
        // Check if we're in rep cooldown period
        const inRepCooldown = (currentTimestamp - lastRepTime) < repCooldownMs;
        
        // Send keypoints if not in jerk recovery mode and not in rep cooldown
        if (!isCameraJerk && !inRepCooldown) {
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
              type: "keypoints",
              keypoints: keypoints,
              exercise: exerciseName  // Explicitly include exercise name
            }));
          }
        } else {
          console.log(`Ignoring frame: ${isCameraJerk ? 'camera jerk' : 'rep cooldown'}`);
        }
        
        lastKeypoints = keypoints;
        lastFrameTimestamp = currentTimestamp;

      } else {
        missingFrames++;
        lastKeypoints = null;
        lastFrameTimestamp = null;
        isCameraJerk = false;
        jerkRecoveryFrames = 0;

        if (missingFrames >= MISSING_THRESHOLD && personDetected) {
          personDetected = false;
          handleNoPersonDetected();
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: "no_person" }));
          }
        }
      }

      canvasCtx.restore();
    }

    function handleNoPersonDetected() {
      document.getElementById("form-status").textContent = "NO PERSON";
      document.getElementById("form-status").className = "status bad";
      document.getElementById("feedback-text").textContent = "No person detected";
    }

    function initializeWebSocket() {
      const wsUrl = `${API_BASE_URL.replace(/^http/, 'ws')}/v1/exercise/ws?session_id=${sessionId}&exercise=${encodeURIComponent(exerciseName)}`;
      ws = new WebSocket(wsUrl);

      ws.onopen = () => console.log("WebSocket connected");

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          console.log('websocket data', data);
          
          // Update rep cooldown if reps increased
          if (data.reps !== undefined) {
            const currentReps = data.reps;
            const previousReps = parseInt(document.getElementById("rep-counter").textContent) || 0;
            
            if (currentReps > previousReps) {
              lastRepTime = Date.now();
              console.log(`Rep counted! Cooldown started. New rep count: ${currentReps}`);
            }
          }
          
          updateUI(data);
        } catch (error) {
          console.error("WebSocket parse error:", error);
        }
      };

      ws.onclose = () => {
        console.log("WebSocket closed");
        setTimeout(initializeWebSocket, 2000);
      };

      ws.onerror = (error) => console.error("WebSocket error:", error);
    }

    function updateUI(data) {
      if (data.exercise) {
        document.getElementById("exercise-name").textContent = data.exercise;
      }
      if (data.reps !== undefined) {
        document.getElementById("rep-counter").textContent = data.reps;
      }
      if (data.form_ok !== undefined) {
        const formStatus = document.getElementById("form-status");
        if (personDetected) {
          formStatus.textContent = data.form_ok ? "OK" : "FIX";
          formStatus.className = "status " + (data.form_ok ? "good" : "bad");
        }
      }
      if (data.feedback !== undefined) {
        if (personDetected) {
          document.getElementById("feedback-text").textContent = data.feedback || "No feedback yet";
        }
      }
    }

    function setupEventListeners() {
      document.getElementById("stop-btn").addEventListener("click", stopExercise);
    }
    let exerciseStopped = false;  
    function stopExercise() {
      if (exerciseStopped) return;   
      exerciseStopped = true;
      if (ws && ws.readyState === WebSocket.OPEN) ws.close(1000, "Exercise stopped by user");
      if (camera) {
        camera.stop();
        camera = null;
      }

      fetch(`${API_BASE_URL}/v1/exercise/stop?session_id=${sessionId}`, { 
        method: "POST",
        headers: { 'Content-Type': 'application/json' }
      }).finally(() => {
        localStorage.removeItem("sessionId");
        localStorage.removeItem("exerciseName");
        window.location.href = "index.html";
      });
    }

    window.addEventListener("beforeunload", stopExercise);
  </script>
</body>
</html>