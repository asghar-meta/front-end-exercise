<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exercise Monitoring</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
</head>
<body>
  <div class="container">
    <header class="exercise-header">
      <h1 id="exercise-name">Exercise</h1>
      <button id="stop-btn">Stop Exercise</button>
    </header>
    
    <main class="exercise-container">
      <div class="stats-panel">
        <div class="stat-box">
          <h3>REPS</h3>
          <div id="rep-counter" class="counter">0</div>
        </div>
        
        <div class="stat-box">
          <h3>FORM</h3>
          <div id="form-status" class="status">OK</div>
        </div>
      </div>
      
      <div class="video-feed">
        <div class="video-placeholder" style="position: relative; display:inline-block;">
          <!-- Hidden raw camera (only for processing) -->
          <video id="camera-stream" autoplay playsinline width="640" height="480" style="display:none;"></video>
          
          <!-- Main canvas where video + landmarks are drawn -->
          <canvas id="overlay-canvas" width="640" height="480" 
                  style="border:2px solid #444; border-radius:8px;"></canvas>

          <!-- Hidden canvas for backend uploads -->
          <canvas id="capture-canvas" width="640" height="480" style="display:none;"></canvas>
        </div>
      </div>
      
      <div class="feedback-panel">
        <h3>FEEDBACK</h3>
        <div id="feedback-text" class="feedback-text">No feedback yet</div>
      </div>
    </main>
  </div>

  <script>
    //   const API_BASE_URL = 'http://localhost:8000';
      const API_BASE_URL = 'https://yalla-ai.onlinetestingserver.com';

      let ws = null;
      let frameInterval = null;
      let isProcessing = false; 
      let reconnectTimeout = null;

      const sessionId = localStorage.getItem("sessionId");
      const exerciseName = localStorage.getItem("exerciseName");
        console.log('session id: ', sessionId)
      document.addEventListener("DOMContentLoaded", () => {
          if (!sessionId) {
              alert("No active session. Redirecting...");
              window.location.href = "index.html";
              return;
          }
          document.getElementById("exercise-name").textContent = exerciseName || "Exercise";

          initializeMediapipe(); 
          initializeWebSocket(); 
          setupEventListeners();
      });

      function initializeMediapipe() {
          const video = document.getElementById("camera-stream");
          const overlay = document.getElementById("overlay-canvas");
          const ctx = overlay.getContext("2d");

          const pose = new Pose({
              locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
          });
          pose.setOptions({
              modelComplexity: 1,
              smoothLandmarks: true,
              enableSegmentation: false,
              minDetectionConfidence: 0.5,
              minTrackingConfidence: 0.5
          });

          pose.onResults(results => {
            ctx.clearRect(0, 0, overlay.width, overlay.height);

            if (results.image) {
              ctx.drawImage(results.image, 0, 0, overlay.width, overlay.height);
            }

            if (results.poseLandmarks) {
              drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS,
                            { color: "lime", lineWidth: 3 });
              drawLandmarks(ctx, results.poseLandmarks,
                            { color: "red", radius: 4 });
            }
          });

          const camera = new Camera(video, {
              onFrame: async () => {
                  await pose.send({ image: video });
              },
              width: 640,
              height: 480
          });
          camera.start();

          // still send frames to backend
          frameInterval = setInterval(captureAndSendFrame, 125); 
      }

      function captureAndSendFrame() {
          if (isProcessing) return;
          isProcessing = true;

          const video = document.getElementById("camera-stream");
          const canvas = document.getElementById("capture-canvas");
          const ctx = canvas.getContext("2d");

          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          
          canvas.toBlob((blob) => {
            if (!blob) {
                isProcessing = false;
                return;
            }

            fetch(`${API_BASE_URL}/v1/exercise/upload_frame?session_id=${sessionId}`, {
                method: "POST",
                headers: { "Content-Type": "image/jpeg" },
                body: blob
            })
            .then(response => response.json())
            .then(data => {
                isProcessing = false;
                if (data.status === "error") {
                    console.error("Backend error:", data.message);
                }
            })
            .catch(error => {
                console.error("Upload failed:", error);
                isProcessing = false;
            });
        }, "image/jpeg", 0.6);
      }

      function initializeWebSocket() {
          const wsUrl = `wss://yalla-ai.onlinetestingserver.com/v1/exercise/ws?session_id=${sessionId}`;
        //   const wsUrl = `ws://localhost:8000/v1/exercise/ws?session_id=${sessionId}`;

          ws = new WebSocket(wsUrl);

          ws.onopen = () => {
              console.log("WebSocket connected");
              ws.send("get_state");
          };

          ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'ping') {
                    ws.send(JSON.stringify({ type: 'pong', ts: data.ts }));
                    return;
                }
                updateUI(data);
            } catch (error) {
                console.error("WebSocket parse error:", error);
            }
          };

          ws.onclose = () => {
              console.log("WebSocket closed. Reconnecting...");
              if (reconnectTimeout) clearTimeout(reconnectTimeout);
              reconnectTimeout = setTimeout(initializeWebSocket, 2000);
          };

          ws.onerror = (error) => {
              console.error("WebSocket error:", error);
          };
      }

      function updateUI(data) {
          if (data.exercise) {
              document.getElementById("exercise-name").textContent = data.exercise;
          }
          if (data.reps !== undefined) {
              document.getElementById("rep-counter").textContent = data.reps;
          }
          if (data.form_ok !== undefined) {
              const formStatus = document.getElementById("form-status");
              if (data.feedback === "No person detected") {
                  formStatus.textContent = "NO PERSON";
                  formStatus.className = "status bad";
              } else {
                  formStatus.textContent = data.form_ok ? "OK" : "FIX";
                  formStatus.className = "status " + (data.form_ok ? "good" : "bad");
              }
          }
          if (data.feedback !== undefined) {
              document.getElementById("feedback-text").textContent = data.feedback || "No feedback yet";
          }
      } 

      function setupEventListeners() {
          document.getElementById("stop-btn").addEventListener("click", stopExercise);
      }

      function stopExercise() {
          if (frameInterval) {
              clearInterval(frameInterval);
              frameInterval = null;
          }
          if (reconnectTimeout) {
              clearTimeout(reconnectTimeout);
              reconnectTimeout = null;
          }
          isProcessing = false;
          
          if (ws) {
              ws.close();
          }

          fetch(`${API_BASE_URL}/v1/exercise/stop?session_id=${sessionId}`, { method: "POST" })
          .finally(() => {
              ws = null;
              localStorage.removeItem("sessionId");
              localStorage.removeItem("exerciseName");
              window.location.href = "index.html";
          });
      }

      window.addEventListener("beforeunload", stopExercise);
  </script>
</body>
</html>
